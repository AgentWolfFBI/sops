// IMPORTANT: This file contains the logic which drives the Flow Calculator. Do not edit this file. Additional data can be added to the flowData.js file.

import { flowData } from './flowData.js';

document.addEventListener('DOMContentLoaded', function() {  
    const landingTimeCalculators = document.getElementsByClassName("flowCalculatorLandingTime");
    const feederFixTimeCalculators = document.getElementsByClassName("flowCalculatorFeederFixTime");

    // Create landing time calculators
    for (let i = 0; i < landingTimeCalculators.length; i++) {
        // Determine which aerodrome to use
        let aerodrome = null;
        for (const key in flowData) {
            if (landingTimeCalculators[i].getAttribute('data-aerodrome') === key) {
                aerodrome = key;
            }
        }

        // Create form elements
        if (aerodrome !== null) {
            CreateFormElements(aerodrome, landingTimeCalculators[i]);

            // Add event listeners
            const elementIDPrefix = aerodrome + "FlowCalculatorLandingTime";
            const ffETAInput = document.getElementById(elementIDPrefix + "FFETA");
            const runwaySelect = document.getElementById(elementIDPrefix + "Runway");
            const arrivalSelect = document.getElementById(elementIDPrefix + "Arrival");
            const aircraftSelect = document.getElementById(elementIDPrefix + "Aircraft");
            const speedSelect = document.getElementById(elementIDPrefix + "Speed");

            ffETAInput.addEventListener("input", function() {
                CalculateLandingTime(aerodrome);
            });
            runwaySelect.addEventListener("change", function() {
                const selectedRunway = runwaySelect.value;
                arrivalSelect.innerHTML = GenerateArrivalOptions(aerodrome, selectedRunway, arrivalSelect.value);
                aircraftSelect.innerHTML = GenerateAircraftTypeOptions(aerodrome, selectedRunway, arrivalSelect.value, aircraftSelect.value);
                speedSelect.innerHTML = GenerateSpeedOptions(aerodrome, runwaySelect.value, arrivalSelect.value, speedSelect.value);
                CalculateLandingTime(aerodrome);
            });
            arrivalSelect.addEventListener("change", function() {
                aircraftSelect.innerHTML = GenerateAircraftTypeOptions(aerodrome, runwaySelect.value, arrivalSelect.value, aircraftSelect.value);
                speedSelect.innerHTML = GenerateSpeedOptions(aerodrome, runwaySelect.value, arrivalSelect.value, speedSelect.value);
                CalculateLandingTime(aerodrome);
            });
            aircraftSelect.addEventListener("change", function() {
                speedSelect.innerHTML = GenerateSpeedOptions(aerodrome, runwaySelect.value, arrivalSelect.value, speedSelect.value);
                CalculateLandingTime(aerodrome);
            });
            speedSelect.addEventListener("change", function() {
                CalculateLandingTime(aerodrome);
            });
        }
    }

    // Create feeder fix time calculators
    for (let i = 0; i < feederFixTimeCalculators.length; i++) {
        // Determine which aerodrome to use
        let aerodrome = null;
        for (const key in flowData) {
            if (feederFixTimeCalculators[i].getAttribute('data-aerodrome') === key) {
                aerodrome = key;
            }
        }

        // Create form elements
        if (aerodrome !== null) {
            CreateFormElements(aerodrome, feederFixTimeCalculators[i]);

            // Add event listeners
            const elementIDPrefix = aerodrome + "FlowCalculatorFeederFixTime";
            const landingTimeInput = document.getElementById(elementIDPrefix + "LandingTime");
            const runwaySelect = document.getElementById(elementIDPrefix + "Runway");
            const arrivalSelect = document.getElementById(elementIDPrefix + "Arrival");
            const aircraftSelect = document.getElementById(elementIDPrefix + "Aircraft");
            const speedSelect = document.getElementById(elementIDPrefix + "Speed");

            landingTimeInput.addEventListener("input", function() {
                CalculateFeederFixTime(aerodrome);
            });
            runwaySelect.addEventListener("change", function() {
                const selectedRunway = runwaySelect.value;
                arrivalSelect.innerHTML = GenerateArrivalOptions(aerodrome, selectedRunway, arrivalSelect.value);
                aircraftSelect.innerHTML = GenerateAircraftTypeOptions(aerodrome, selectedRunway, arrivalSelect.value, aircraftSelect.value);
                speedSelect.innerHTML = GenerateSpeedOptions(aerodrome, runwaySelect.value, arrivalSelect.value, speedSelect.value);
                CalculateFeederFixTime(aerodrome);
            });
            arrivalSelect.addEventListener("change", function() {
                aircraftSelect.innerHTML = GenerateAircraftTypeOptions(aerodrome, runwaySelect.value, arrivalSelect.value, aircraftSelect.value);
                speedSelect.innerHTML = GenerateSpeedOptions(aerodrome, runwaySelect.value, arrivalSelect.value, speedSelect.value);
                CalculateFeederFixTime(aerodrome);
            });
            aircraftSelect.addEventListener("change", function() {
                speedSelect.innerHTML = GenerateSpeedOptions(aerodrome, runwaySelect.value, arrivalSelect.value, speedSelect.value);
                CalculateFeederFixTime(aerodrome);
            });
            speedSelect.addEventListener("change", function() {
                CalculateFeederFixTime(aerodrome);
            });
        }
    }
});

function CreateFormElements(aerodrome, containerElement) {
    let elementIDPrefix = aerodrome;
    let formContent = "";
    let resultsRow = "";

    const sortedRunways = Object.keys(flowData[aerodrome]).sort((a, b) => a.localeCompare(b));
    const prefillRunway = sortedRunways[0];
    const prefillArrival = RetrieveArrivals(aerodrome, prefillRunway)[0];

    try {
        // Initial inputs
        if(containerElement.classList.contains("flowCalculatorLandingTime")) {
            elementIDPrefix += "FlowCalculatorLandingTime";
            
            formContent = `<div class="row">
            <div class="form-group">
                <label>Feeder Fix ETA:</label>
                <input id="${elementIDPrefix}FFETA" type="number" placeholder="FF ETA" min="0" max="59" step="1" placeholder="00" />
            </div>`;
            resultsRow = `<div class="row"><label style="font-size: 125%;">Landing Time: <span id="${elementIDPrefix}Result" style="color: var(--md-code-hl-string-color)"></span></label></div>`;
        } else if(containerElement.classList.contains("flowCalculatorFeederFixTime")) {
            elementIDPrefix += "FlowCalculatorFeederFixTime";
            
            formContent = `<div class="row">
            <div class="form-group">
                <label>Landing Time:</label>
                <input id="${elementIDPrefix}LandingTime" type="number" placeholder="Landing Time" min="0" max="59" step="1" placeholder="00" />
            </div>`;
            resultsRow = `<div class="row"><label style="font-size: 125%;">Feeder Fix Time: <span id="${elementIDPrefix}Result" style="color: var(--md-code-hl-string-color)"></span></label></div>`;
        }

        // Runways
        formContent += `
            <div class="form-group">
                <label>Runway:</label>
                <select id="${elementIDPrefix}Runway">`;

        for (let runway of sortedRunways) {
            formContent += `<option value="${runway}">${runway}</option>`;
        }

        // Arrivals
        formContent += `</select>
            </div>
            <div class="form-group">
                <label>Arrival:</label>
                <select id="${elementIDPrefix}Arrival">`;

        formContent += GenerateArrivalOptions(aerodrome, prefillRunway, null);
                   
        // Aircraft types
        formContent += `</select>
            </div>
            <div class="form-group">
                <label>Aircraft:</label>
                <select id="${elementIDPrefix}Aircraft">`;
                    
        formContent += GenerateAircraftTypeOptions(aerodrome, prefillRunway, prefillArrival, "Jet");

        // Speed options
        formContent += `</select>
            </div>
            <div class="form-group">
                <label>Speed:</label>
                <select id="${elementIDPrefix}Speed">`;
                    
        formContent += GenerateSpeedOptions(aerodrome, prefillRunway, prefillArrival, "Normal Speed");

        formContent += `</select>
            </div>
        </div>`;

        let form = document.createElement("form");
        form.classList.add("flowCalculator");
        form.setAttribute("autocomplete", "off");
        form.innerHTML = formContent + resultsRow;

        containerElement.appendChild(form);
    } catch (error) {
        console.error("Error creating form elements:", error);
    }
}

function RetrieveArrivals(aerodrome, selectedRunway) {
    // Returns an array of arrivals for the selected runway, sorted alphabetically
    let arrivals = Object.keys(flowData[aerodrome][selectedRunway]);
    let sortedArrivals = arrivals.sort((a, b) => a.localeCompare(b));

    return sortedArrivals;
}

function GenerateArrivalOptions(aerodrome, selectedRunway, previousValue) {
    // Returns a string of HTML options for the arrivals select element
    let arrivalOptions = "";
    let selected = "";
    const sortedArrivals = RetrieveArrivals(aerodrome, selectedRunway);

    for (let arrival of sortedArrivals) {
        if(arrival === previousValue) {
            selected = "selected";
        } else {
            selected = "";
        }
        arrivalOptions += `<option value="${arrival}" ${selected}>${arrival}</option>`;
    }

    return arrivalOptions;
}

function RetrieveAircraftTypes(aerodrome, selectedRunway, selectedArrival) {
    // Returns an array of aircraft types for the selected runway and arrival, sorted alphabetically
    let aircraftTypes = Object.keys(flowData[aerodrome][selectedRunway][selectedArrival]["aircraft"]);
    let sortedAircraftTypes = aircraftTypes.sort((a, b) => a.localeCompare(b));

    return sortedAircraftTypes;
}

function GenerateAircraftTypeOptions(aerodrome, selectedRunway, selectedArrival, previousValue) {
    // Returns a string of HTML options for the aircraft select element
    let aircraftOptions = "";
    let selected = "";
    const sortedAircraft = RetrieveAircraftTypes(aerodrome, selectedRunway, selectedArrival);

    for (let aircraft of sortedAircraft) {
        if(aircraft === previousValue) {
            selected = "selected";
        } else {
            selected = "";
        }
        aircraftOptions += `<option value="${aircraft}" ${selected}>${aircraft}</option>`;
    }

    return aircraftOptions;
}

function RetrieveSpeeds(aerodrome, selectedRunway, selectedArrival) {
    // Returns an array of speeds for the selected runway and arrival
    let speedOptions = Object.keys(flowData[aerodrome][selectedRunway][selectedArrival]["corrections"]);
    speedOptions.push("Normal Speed");
    let sortedSpeedOptions = speedOptions.sort((a, b) => a.localeCompare(b));

    return sortedSpeedOptions;
}

function GenerateSpeedOptions(aerodrome, selectedRunway, selectedArrival, previousValue) {
    // Returns a string of HTML options for the speeds select element
    let speedOptions = "";
    let selected = "";
    const sortedSpeeds = RetrieveSpeeds(aerodrome, selectedRunway, selectedArrival);

    for (let speed of sortedSpeeds) {
        if(speed === previousValue) {
            selected = "selected";
        } else {
            selected = "";
        }
        speedOptions += `<option value="${speed}" ${selected}>${speed}</option>`;
    }

    return speedOptions;
}

function CalculateLandingTime(aerodrome) {
    // Calculates the landing time and updates the UI
    try {
        const elementIDPrefix = aerodrome + "FlowCalculatorLandingTime";
        const ffETAInput = document.getElementById(elementIDPrefix + "FFETA");
        const runwaySelect = document.getElementById(elementIDPrefix + "Runway");
        const arrivalSelect = document.getElementById(elementIDPrefix + "Arrival");
        const aircraftSelect = document.getElementById(elementIDPrefix + "Aircraft");
        const speedSelect = document.getElementById(elementIDPrefix + "Speed");
        const resultSpan = document.getElementById(elementIDPrefix + "Result");

        // Get values from inputs
        const ffETA = parseInt(ffETAInput.value, 10);
        const selectedRunway = runwaySelect.value;
        const selectedArrival = arrivalSelect.value;
        const selectedAircraft = aircraftSelect.value;
        const selectedSpeed = speedSelect.value;

        // Calculate landing time
        let landingTime = flowData[aerodrome][selectedRunway][selectedArrival]["aircraft"][selectedAircraft] + ffETA;
        if(selectedSpeed != "Normal Speed") {
            landingTime += flowData[aerodrome][selectedRunway][selectedArrival]["corrections"][selectedSpeed];
        }
        if(landingTime < 0) {
            landingTime += 60;
        } else if(landingTime > 59) {
            landingTime -= 60;
        }

        // Display result
        if(String(landingTime) === "NaN" || landingTime == undefined || landingTime == null) {
            resultSpan.textContent = "";
        } else {
            resultSpan.textContent = `${String(landingTime).padStart(2, '0')}`;
        }
    } catch (error) {
        console.error("Error calculating landing time:", error);
        document.getElementById('flowCalculatorLandingTimeResult').textContent = "Error";
    }
}

function CalculateFeederFixTime(aerodrome) {
    // Calculates the feeder fix time and updates the UI
    try {
        const elementIDPrefix = aerodrome + "FlowCalculatorFeederFixTime";
        const landingTimeInput = document.getElementById(elementIDPrefix + "LandingTime");
        const runwaySelect = document.getElementById(elementIDPrefix + "Runway");
        const arrivalSelect = document.getElementById(elementIDPrefix + "Arrival");
        const aircraftSelect = document.getElementById(elementIDPrefix + "Aircraft");
        const speedSelect = document.getElementById(elementIDPrefix + "Speed");
        const resultSpan = document.getElementById(elementIDPrefix + "Result");

        // Get values from inputs
        const landingTime = parseInt(landingTimeInput.value, 10);
        const selectedRunway = runwaySelect.value;
        const selectedArrival = arrivalSelect.value;
        const selectedAircraft = aircraftSelect.value;
        const selectedSpeed = speedSelect.value;

        // Calculate feeder fix time
        let feederFixTime = landingTime - flowData[aerodrome][selectedRunway][selectedArrival]["aircraft"][selectedAircraft];
        if(selectedSpeed != "Normal Speed") {
            feederFixTime -= flowData[aerodrome][selectedRunway][selectedArrival]["corrections"][selectedSpeed];
        }
        if(feederFixTime < 0) {
            feederFixTime += 60;
        } else if(feederFixTime > 59) {
            feederFixTime -= 60;
        }

        // Display result
        if(String(feederFixTime) === "NaN" || feederFixTime == undefined || feederFixTime == null) {
            resultSpan.textContent = "";
        } else {
            resultSpan.textContent = `${String(feederFixTime).padStart(2, '0')}`;
        }
    } catch (error) {
        console.error("Error calculating feeder fix time:", error);
        document.getElementById('flowCalculatorFeederFixTimeResult').textContent = "Error";
    }
}
